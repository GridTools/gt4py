#
# GT4Py - GridTools Framework
#
# Copyright (c) 2014-2024, ETH Zurich
# All rights reserved.
#
# Please, refer to the LICENSE file in the root directory.
# SPDX-License-Identifier: BSD-3-Clause
#

# This is the main entry point for the CSCS CI pipeline and assembles
# the build and the test trigger jobs with pieces from the included files.
# Note: 'definition-from-cscs-ci-ext', 'definition_from_yaml_file_in_this_repo'
#
# The build job creates two things:
# - the base image for the CSCS CI (only if the external dependencies change)
# - the actual CI pipeline for this commit (in the 'after_script' section).
#
# The generated pipeline is stored in the `generated_cscs_test_pipeline.yml` file,
# which is then used by the test trigger jobs to run the tests.

include:
  - local: 'ci/cscs-common.yml'

# Base image build jobs
build_cscs_gh200:
  extends:
    - .container-builder-cscs-gh200
    - .build_base_common
    - .build_with_cuda_extra
  variables:
    RUNNER_KEY: test_cscs_gh200

# .build_base_cscs_amd_rocm:
#   extends:
#     - .container-builder-cscs-zen2
#     - .build_base_common
#     - .build_with_rocm_extra
#   variables:
#     RUNNER_KEY: test_cscs_amd_rocm

# Trigger jobs for the generated test pipeline
test_trigger_cscs_gh200:
  stage: test
  extends:
    - .test_trigger_base
  trigger:
    include:
      - artifact: generated_cscs_test_pipeline.yml
        job: build_cscs_gh200

# .test_trigger_cscs_amd_rocm:
#   stage: test
#   extends:
#     - .tds-container-runner-beverin-mi200
#     - .test_trigger_base
#   needs:
#     - build_base_cscs_amd_rocm
#   trigger:
#     include:
#       - artifact: generated_cscs_test_pipeline.yml
#         job: build_base_cscs_amd_rocm
