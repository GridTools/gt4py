include:
- remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

build images:
  stage: build

  parallel:
    matrix:
    - PYVERSION_PREFIX: py310
      PYVERSION: 3.10.9
    - PYVERSION_PREFIX: py39
      PYVERSION: 3.9.1
    - PYVERSION_PREFIX: py38
      PYVERSION: 3.8.5

  trigger:
    include:
    - local: ci/images.yml
    strategy: depend


run tests:
  extends: .container-runner-daint-gpu
  stage: test
  image: $CSCS_REGISTRY_PATH/gt4py/gt4py-ci:$PYVERSION
  needs: ["build images"]
  script:
  - cd /gt4py.src
  - python -c "import cupy"
  - tox run -e $SUBPACKAGE-$PYVERSION_PREFIX-$BACKEND-cuda112
  variables:
    CRAY_CUDA_MPS: 1
    SLURM_JOB_NUM_NODES: 1
    SLURM_TIMELIMIT: 120
    NUM_PROCESSES: auto
    VIRTUALENV_SYSTEM_SITE_PACKAGES: 1
  parallel:
    matrix:
    - PYVERSION_PREFIX: py310
      PYVERSION: 3.10.9
      SUBPACKAGE: [cartesian, storage]
      BACKEND: [internal, dace]
    - PYVERSION_PREFIX: py39
      PYVERSION: 3.9.1
      SUBPACKAGE: [cartesian, storage]
      BACKEND: [internal, dace]
    - PYVERSION_PREFIX: py38
      PYVERSION: 3.8.5
      SUBPACKAGE: [cartesian, storage]
      BACKEND: [internal, dace]
