<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gt4py.cartesian.frontend.gtscript_frontend &mdash; GT4Py 0.1.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> GT4Py
          </a>
              <div class="version">
                0.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">GT4Py: GridTools for Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arrays.html">Allocation and Array Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../commandline.html">Commandline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apiref.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../indices.html">Indices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../GDPs/gdp-index.html">GT4Py Development</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">GT4Py</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">gt4py.cartesian.frontend.gtscript_frontend</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gt4py.cartesian.frontend.gtscript_frontend</h1><div class="highlight"><pre>
<span></span><span class="c1"># GT4Py - GridTools Framework</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2014-2022, ETH Zurich</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of the GT4Py project and the GridTools framework.</span>
<span class="c1"># GT4Py is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU General Public License as published by the</span>
<span class="c1"># Free Software Foundation, either version 3 of the License, or any later</span>
<span class="c1"># version. See the LICENSE.txt file at the top-level directory of this</span>
<span class="c1"># distribution for a copy of the license or check &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: GPL-3.0-or-later</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">gt4py.cartesian</span> <span class="kn">import</span> <span class="n">definitions</span> <span class="k">as</span> <span class="n">gt_definitions</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian</span> <span class="kn">import</span> <span class="n">gtscript</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">gt_utils</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian.frontend</span> <span class="kn">import</span> <span class="n">node_util</span><span class="p">,</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian.frontend.defir_to_gtir</span> <span class="kn">import</span> <span class="n">DefIRToGTIR</span><span class="p">,</span> <span class="n">UnrollVectorAssignments</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian.gtc</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">gtc_utils</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian.utils</span> <span class="kn">import</span> <span class="n">NOTHING</span>
<span class="kn">from</span> <span class="nn">gt4py.cartesian.utils</span> <span class="kn">import</span> <span class="n">meta</span> <span class="k">as</span> <span class="n">gt_meta</span>

<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Frontend</span><span class="p">,</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GTScriptAssertionError</span><span class="p">,</span>
    <span class="n">GTScriptDataTypeError</span><span class="p">,</span>
    <span class="n">GTScriptDefinitionError</span><span class="p">,</span>
    <span class="n">GTScriptSymbolError</span><span class="p">,</span>
    <span class="n">GTScriptSyntaxError</span><span class="p">,</span>
    <span class="n">GTScriptValueError</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">PYTHON_AST_VERSION</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>


<div class="viewcode-block" id="AssertionChecker"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AssertionChecker">[docs]</a><span class="k">class</span> <span class="nc">AssertionChecker</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check assertions and remove from the AST for further parsing.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AssertionChecker.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AssertionChecker.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">checker</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">checker</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">func_node</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

    <span class="k">def</span> <span class="nf">_process_assertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">condition_value</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ast_eval</span><span class="p">(</span><span class="n">expr_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">condition_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">condition_value</span><span class="p">:</span>
                <span class="n">source_lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">expr_node</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">GTScriptAssertionError</span><span class="p">(</span><span class="n">source_lines</span><span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="s2">&quot;Evaluation of compile_assert condition failed at the preprocessing step.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_process_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">]:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_qualified_name_from_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;compile_assert&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid assertion. Correct syntax: compile_assert(condition)&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_assertion</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="AssertionChecker.visit_Expr"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AssertionChecker.visit_Expr">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_call</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span> <span class="k">if</span> <span class="n">ret</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span></div></div>


<div class="viewcode-block" id="AxisIntervalParser"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser">[docs]</a><span class="k">class</span> <span class="nc">AxisIntervalParser</span><span class="p">(</span><span class="n">gt_meta</span><span class="o">.</span><span class="n">ASTPass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse Python AST interval syntax in the form of a Slice.</span>

<span class="sd">    Corner cases: `ast.Ellipsis` refers to the entire interval, and</span>
<span class="sd">    if an `ast.Subscript` is passed, this parses its slice attribute.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AxisIntervalParser.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Ellipsis</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">],</span>
        <span class="n">axis_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Ellipsis</span><span class="p">):</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="o">.</span><span class="n">full_interval</span><span class="p">()</span>
            <span class="n">interval</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="k">return</span> <span class="n">interval</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">):</span>
            <span class="n">slice_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;slice&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">):</span>
            <span class="n">slice_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_node</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">slice_from_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slice_node</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slice_node</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">slice_node</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">slice_node</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">axis_name</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">sequential_axis</span><span class="o">.</span><span class="n">name</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">parser</span><span class="o">.</span><span class="n">interval_error</span>

        <span class="k">if</span> <span class="n">slice_node</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slice_node</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">slice_node</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">slice_node</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_make_axis_bound</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_make_axis_bound</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_name</span> <span class="o">=</span> <span class="n">axis_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid interval range specification&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2"> at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column: </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

<div class="viewcode-block" id="AxisIntervalParser.slice_from_value"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.slice_from_value">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">slice_from_value</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an ast.Slice node from a general ast.Expr node.&quot;&quot;&quot;</span>
        <span class="n">slice_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">(</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">(),</span> <span class="n">right</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">slice_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">slice_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice_node</span></div>

    <span class="k">def</span> <span class="nf">_make_axis_bound</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">],</span>
        <span class="n">endpt</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">END</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span> <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">END</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">LARGE_NUM</span> <span class="o">=</span> <span class="mi">10000</span>
                <span class="n">seq_name</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">sequential_axis</span><span class="o">.</span><span class="n">name</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">endpt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_name</span> <span class="o">==</span> <span class="n">seq_name</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">LARGE_NUM</span> <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span> <span class="k">else</span> <span class="n">LARGE_NUM</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span>

            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span>

<div class="viewcode-block" id="AxisIntervalParser.visit_Name"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="AxisIntervalParser.visit_Constant"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.visit_Constant">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected type found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">. Expected one of: int, AxisIndex, string (var ref), or None.&quot;</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="AxisIntervalParser.visit_BinOp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.visit_BinOp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">):</span>
            <span class="n">bin_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>  <span class="c1"># noqa: E731</span>
            <span class="n">u_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>  <span class="c1"># noqa: E731</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Sub</span><span class="p">):</span>
            <span class="n">bin_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>  <span class="c1"># noqa: E731</span>
            <span class="n">u_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span>  <span class="c1"># noqa: E731</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">level</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="p">):</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span>
            <span class="n">bin_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>  <span class="c1"># noqa: E731</span>
            <span class="n">u_op</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="s2">&quot;Unexpected binary operator found in interval expression&quot;</span><span class="p">)</span>

        <span class="n">incompatible_types_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="s2">&quot;Incompatible types found in interval expression&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">incompatible_types_error</span>
            <span class="k">return</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">(</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">bin_op</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">incompatible_types_error</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">u_op</span><span class="p">(</span><span class="n">right</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">incompatible_types_error</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">left</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">bin_op</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bin_op</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></div>

<div class="viewcode-block" id="AxisIntervalParser.visit_UnaryOp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.visit_UnaryOp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">USub</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span>  <span class="c1"># noqa: E731</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span></div>

<div class="viewcode-block" id="AxisIntervalParser.visit_Subscript"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.AxisIntervalParser.visit_Subscript">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisBound</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_error</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ValueInliner"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner">[docs]</a><span class="k">class</span> <span class="nc">ValueInliner</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
<div class="viewcode-block" id="ValueInliner.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">inliner</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">inliner</span><span class="p">(</span><span class="n">func_node</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="ValueInliner.__call__"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">func_node</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_replace_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_attr_node</span><span class="p">):</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">name_or_attr_node</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_qualified_name_from_node</span><span class="p">(</span><span class="n">name_or_attr_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qualified_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">qualified_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Axis</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to inline </span><span class="si">{</span><span class="n">qualified_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_node</span>

<div class="viewcode-block" id="ValueInliner.visit_ImportFrom"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.visit_ImportFrom">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="ValueInliner.visit_Attribute"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.visit_Attribute">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValueInliner.visit_Name"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValueInliner.visit_FunctionDef"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ValueInliner.visit_FunctionDef">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span></div></div>


<div class="viewcode-block" id="ReturnReplacer"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ReturnReplacer">[docs]</a><span class="k">class</span> <span class="nc">ReturnReplacer</span><span class="p">(</span><span class="n">gt_utils</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ASTTransformPass</span><span class="p">):</span>
<div class="viewcode-block" id="ReturnReplacer.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ReturnReplacer.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ast_object</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">target_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure that there is only a single return statement (can still return a tuple).&quot;&quot;&quot;</span>
        <span class="n">ret_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">ast_object</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ret_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="s2">&quot;GTScript Functions should have a single return statement&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast_object</span><span class="p">,</span> <span class="n">target_node</span><span class="o">=</span><span class="n">target_node</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_num_values</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>

<div class="viewcode-block" id="ReturnReplacer.visit_Return"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ReturnReplacer.visit_Return">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">target_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">:</span>
        <span class="n">rhs_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_values</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">lhs_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_num_values</span><span class="p">(</span><span class="n">target_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lhs_length</span> <span class="o">==</span> <span class="n">rhs_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span>
                <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">target_node</span><span class="p">],</span>
                <span class="n">value</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="n">col_offset</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="s2">&quot;Number of returns values does not match arguments on left side&quot;</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="CallInliner"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner">[docs]</a><span class="k">class</span> <span class="nc">CallInliner</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inlines calls to gtscript.function calls.</span>

<span class="sd">    Calls to NativeFunctions (intrinsic math functions) are kept in the IR and</span>
<span class="sd">    dealt with in the IRMaker.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CallInliner.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">call_stack</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">inliner</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">call_stack</span><span class="o">=</span><span class="n">call_stack</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">inliner</span><span class="p">(</span><span class="n">func_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inliner</span><span class="o">.</span><span class="n">all_skip_names</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">call_stack</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span> <span class="o">=</span> <span class="n">call_stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_skip_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gtscript</span><span class="o">.</span><span class="n">builtins</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;gt4py&quot;</span><span class="p">,</span> <span class="s2">&quot;gtscript&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="CallInliner.__call__"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_name</span> <span class="o">=</span> <span class="n">func_node</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">func_node</span><span class="p">)</span></div>

<div class="viewcode-block" id="CallInliner.visit"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit">[docs]</a>    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visit a node.&quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;visit_&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_process_stmts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmts</span><span class="p">):</span>
        <span class="n">new_stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">outer_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="n">new_stmts</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stmts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="n">new_stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="n">outer_block</span>

        <span class="k">return</span> <span class="n">new_stmts</span>

<div class="viewcode-block" id="CallInliner.visit_FunctionDef"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_FunctionDef">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stmts</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="CallInliner.visit_With"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_With">[docs]</a>    <span class="k">def</span> <span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stmts</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="CallInliner.visit_If"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stmts</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stmts</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="CallInliner.visit_Assert"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_Assert">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assert</span><span class="p">):</span>
        <span class="c1"># Assertions are removed in the AssertionChecker later.</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="CallInliner.visit_Assign"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_qualified_name_from_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">MATH_BUILTINS</span>
        <span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">target_node</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># This node can be now removed since the trivial assignment has been already done</span>
            <span class="c1"># in the Call visitor</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="CallInliner.visit_Call"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span>  <span class="c1"># noqa: C901 # Cyclomatic complexity too high</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">target_node</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_qualified_name_from_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">call_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found recursive function call &#39;</span><span class="si">{</span><span class="n">call_name</span><span class="si">}</span><span class="s2">&#39; in the stack.&quot;</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">call_name</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">IGNORE_WHEN_INLINING</span><span class="p">:</span>
            <span class="c1"># Not a function to inline, return as-is.</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">elif</span> <span class="n">call_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">call_name</span><span class="p">],</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="s2">&quot;Unknown call&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="c1"># Recursively inline any possible nested subroutine call</span>
        <span class="n">call_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">call_name</span><span class="p">]</span><span class="o">.</span><span class="n">_gtscript_</span>
        <span class="n">call_ast</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">call_info</span><span class="p">[</span><span class="s2">&quot;ast&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_name</span> <span class="o">=</span> <span class="n">call_name</span>
        <span class="n">CallInliner</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">call_ast</span><span class="p">,</span> <span class="n">call_info</span><span class="p">[</span><span class="s2">&quot;local_context&quot;</span><span class="p">],</span> <span class="n">call_stack</span><span class="o">=</span><span class="p">{</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">,</span> <span class="n">call_name</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Extract call arguments</span>
        <span class="n">call_signature</span> <span class="o">=</span> <span class="n">call_info</span><span class="p">[</span><span class="s2">&quot;api_signature&quot;</span><span class="p">]</span>
        <span class="n">arg_infos</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">call_signature</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_signature</span><span class="p">)</span>
            <span class="n">call_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">call_signature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_keyword</span>
                <span class="n">call_args</span><span class="p">[</span><span class="n">call_signature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg_value</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">arg</span> <span class="ow">in</span> <span class="n">arg_infos</span>
                <span class="n">call_args</span><span class="p">[</span><span class="n">kwarg</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># Add default values for missing args when possible</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_infos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">call_args</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">arg_infos</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Empty</span>
                    <span class="n">call_args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">arg_infos</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid call signature&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Rename local names in subroutine to avoid conflicts with caller context names</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">assign_targets</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">collect_assign_targets</span><span class="p">(</span><span class="n">call_ast</span><span class="p">,</span> <span class="n">allow_multiple_targets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Assignment to more than one target is not supported.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">assigned_symbols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">assign_targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Unsupported assignment target.&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

            <span class="n">assigned_symbols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">name_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assigned_symbols</span>
        <span class="p">}</span>

        <span class="n">call_id</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">shashed_id</span><span class="p">(</span><span class="n">call_name</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">call_id_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">call_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">template_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">__&quot;</span> <span class="o">+</span> <span class="n">call_id_suffix</span>

        <span class="n">gt_meta</span><span class="o">.</span><span class="n">map_symbol_names</span><span class="p">(</span>
            <span class="n">call_ast</span><span class="p">,</span> <span class="n">name_mapping</span><span class="p">,</span> <span class="n">template_fmt</span><span class="o">=</span><span class="n">template_fmt</span><span class="p">,</span> <span class="n">skip_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_skip_names</span>
        <span class="p">)</span>

        <span class="c1"># Replace returns by assignments in subroutine</span>
        <span class="k">if</span> <span class="n">target_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">call_ast</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;Only functions with a single return value can be used in expressions, including as call arguments. &quot;</span>
                    <span class="s2">&quot;Please assign the function results to symbols first.&quot;</span>
                <span class="p">)</span>
            <span class="n">target_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">(),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="n">col_offset</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">template_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;RETURN_VALUE&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">target_node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span>
        <span class="p">)</span>

        <span class="n">ReturnReplacer</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">call_ast</span><span class="p">,</span> <span class="n">target_node</span><span class="p">)</span>

        <span class="c1"># Add subroutine sources prepending the required arg assignments</span>
        <span class="n">inlined_stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_mapping</span><span class="p">:</span>
                <span class="n">inlined_stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span>
                        <span class="n">lineno</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                        <span class="n">col_offset</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                        <span class="n">targets</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                                <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">(),</span>
                                <span class="n">lineno</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                                <span class="n">col_offset</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                                <span class="nb">id</span><span class="o">=</span><span class="n">template_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">arg_name</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">],</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">arg_value</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Add inlined statements to the current block and return name node with the result</span>
        <span class="n">inlined_stmts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">call_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inlined_stmts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">result_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">(),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="n">col_offset</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
            <span class="n">result_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">(),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="n">col_offset</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                <span class="n">elts</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">elts</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">(),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="n">col_offset</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="nb">slice</span><span class="o">=</span><span class="n">target_node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add the temp_annotations and temp_init_values to the parent</span>
        <span class="n">current_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span><span class="o">.</span><span class="n">_gtscript_</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">call_info</span><span class="p">[</span><span class="s2">&quot;temp_annotations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">name_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">current_info</span><span class="p">[</span><span class="s2">&quot;temp_annotations&quot;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">call_info</span><span class="p">[</span><span class="s2">&quot;temp_init_values&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">name_mapping</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">current_info</span><span class="p">[</span><span class="s2">&quot;temp_init_values&quot;</span><span class="p">][</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">result_node</span></div>

<div class="viewcode-block" id="CallInliner.visit_Expr"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CallInliner.visit_Expr">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ignore pure string statements in callee.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CompiledIfInliner"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CompiledIfInliner">[docs]</a><span class="k">class</span> <span class="nc">CompiledIfInliner</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
<div class="viewcode-block" id="CompiledIfInliner.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CompiledIfInliner.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ast_object</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">stencil_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">cls</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stencil_name</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast_object</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">stencil_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stencil_name</span> <span class="o">=</span> <span class="n">stencil_name</span>

<div class="viewcode-block" id="CompiledIfInliner.visit_If"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CompiledIfInliner.visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
        <span class="c1"># Compile-time evaluation of &quot;if&quot; conditions</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;__INLINED&quot;</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;stencil </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stencil_name</span><span class="si">}</span><span class="s2">, line </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">, column </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="si">}</span><span class="s2">: compile-time if condition via __INLINED deprecated&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">eval_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">condition_value</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ast_eval</span><span class="p">(</span><span class="n">eval_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">condition_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="k">if</span> <span class="n">condition_value</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;Evaluation of compile-time &#39;if&#39; condition failed at the preprocessing step&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span> <span class="k">if</span> <span class="n">node</span> <span class="k">else</span> <span class="kc">None</span></div></div>


<span class="k">def</span> <span class="nf">_make_temp_decls</span><span class="p">(</span>
    <span class="n">descriptors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_FieldDescriptor</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">axes</span><span class="p">],</span>
            <span class="n">is_api</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">data_dims</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">data_dims</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_make_init_computations</span><span class="p">(</span>
    <span class="n">temp_decls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">],</span> <span class="n">init_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">func_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_decls</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">stmts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Assign</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">init_values</span><span class="p">:</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="n">temp_decls</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decl</span><span class="o">.</span><span class="n">data_dims</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">data_dims</span><span class="p">)):</span>
                <span class="n">literal_index</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT32</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span>
                <span class="p">]</span>
                <span class="n">stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">FieldRef</span><span class="o">.</span><span class="n">at_center</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">decl</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">data_index</span><span class="o">=</span><span class="n">literal_index</span>
                        <span class="p">),</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">init_values</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">data_type</span><span class="o">=</span><span class="n">decl</span><span class="o">.</span><span class="n">data_type</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">FieldRef</span><span class="o">.</span><span class="n">at_center</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">decl</span><span class="o">.</span><span class="n">axes</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">init_values</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="o">.</span><span class="n">full_interval</span><span class="p">(),</span>
            <span class="n">iteration_order</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">IterationOrder</span><span class="o">.</span><span class="n">PARALLEL</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">stmts</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>


<span class="k">def</span> <span class="nf">_find_accesses_with_offsets</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">FindRefs</span><span class="p">(</span><span class="n">node_util</span><span class="o">.</span><span class="n">IRNodeVisitor</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_FieldRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldRef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">FindRefs</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>


<div class="viewcode-block" id="ParsingContext"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.ParsingContext">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">ParsingContext</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CONTROL_FLOW</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">COMPUTATION</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="IRMaker"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker">[docs]</a><span class="k">class</span> <span class="nc">IRMaker</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">local_symbols</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">domain</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="p">,</span>
        <span class="n">temp_decls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">local_symbols</span> <span class="o">=</span> <span class="n">local_symbols</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">local_symbols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">local_symbols</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span> <span class="o">=</span> <span class="n">local_symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="ow">or</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_decls</span> <span class="o">=</span> <span class="n">temp_decls</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_horizontal_region</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">written_vars</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">PYTHON_SYMBOL_TO_IR_OP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ABS</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">MIN</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">MAX</span><span class="p">,</span>
            <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">MOD</span><span class="p">,</span>
            <span class="s2">&quot;sin&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">SIN</span><span class="p">,</span>
            <span class="s2">&quot;cos&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">COS</span><span class="p">,</span>
            <span class="s2">&quot;tan&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">TAN</span><span class="p">,</span>
            <span class="s2">&quot;asin&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCSIN</span><span class="p">,</span>
            <span class="s2">&quot;acos&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCCOS</span><span class="p">,</span>
            <span class="s2">&quot;atan&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCTAN</span><span class="p">,</span>
            <span class="s2">&quot;sinh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">SINH</span><span class="p">,</span>
            <span class="s2">&quot;cosh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">COSH</span><span class="p">,</span>
            <span class="s2">&quot;tanh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">TANH</span><span class="p">,</span>
            <span class="s2">&quot;asinh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCSINH</span><span class="p">,</span>
            <span class="s2">&quot;acosh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCCOSH</span><span class="p">,</span>
            <span class="s2">&quot;atanh&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ARCTANH</span><span class="p">,</span>
            <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">SQRT</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">EXP</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">LOG</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">GAMMA</span><span class="p">,</span>
            <span class="s2">&quot;cbrt&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">CBRT</span><span class="p">,</span>
            <span class="s2">&quot;isfinite&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ISFINITE</span><span class="p">,</span>
            <span class="s2">&quot;isinf&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ISINF</span><span class="p">,</span>
            <span class="s2">&quot;isnan&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">ISNAN</span><span class="p">,</span>
            <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">FLOOR</span><span class="p">,</span>
            <span class="s2">&quot;ceil&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">CEIL</span><span class="p">,</span>
            <span class="s2">&quot;trunc&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">TRUNC</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="IRMaker.__call__"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast_root</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_root</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;body&quot;</span> <span class="ow">in</span> <span class="n">ast_root</span><span class="o">.</span><span class="n">_fields</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">func_ast</span> <span class="o">=</span> <span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">=</span> <span class="n">ParsingContext</span><span class="o">.</span><span class="n">CONTROL_FLOW</span>
        <span class="n">computations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">func_ast</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">computations</span></div>

    <span class="c1"># Helpers functions</span>
    <span class="k">def</span> <span class="nf">_is_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>

    <span class="k">def</span> <span class="nf">_is_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

    <span class="k">def</span> <span class="nf">_is_local_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span>

    <span class="k">def</span> <span class="nf">_is_known</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_local_symbol</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_are_blocks_sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compute_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">]):</span>
        <span class="k">def</span> <span class="nf">sort_blocks_key</span><span class="p">(</span><span class="n">comp_block</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">comp_block</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">start</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span> <span class="k">else</span> <span class="mi">100000</span>
            <span class="n">key</span> <span class="o">+=</span> <span class="n">start</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compute_blocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># validate invariant</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">comp_block</span><span class="o">.</span><span class="n">iteration_order</span> <span class="o">==</span> <span class="n">compute_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iteration_order</span>
            <span class="k">for</span> <span class="n">comp_block</span> <span class="ow">in</span> <span class="n">compute_blocks</span>
        <span class="p">)</span>

        <span class="c1"># extract iteration order</span>
        <span class="n">iteration_order</span> <span class="o">=</span> <span class="n">compute_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iteration_order</span>

        <span class="c1"># sort blocks</span>
        <span class="n">compute_blocks_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">compute_blocks</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">sort_blocks_key</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="n">iteration_order</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">IterationOrder</span><span class="o">.</span><span class="n">BACKWARD</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if sorting didn&#39;t change anything it was already sorted</span>
        <span class="k">return</span> <span class="n">compute_blocks</span> <span class="o">==</span> <span class="n">compute_blocks_sorted</span>

    <span class="k">def</span> <span class="nf">_parse_region_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">ExtSlice</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">],</span> <span class="n">loc</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
            <span class="c1"># Python 3.8 wraps a Tuple in an Index for region[0, 1]</span>
            <span class="n">tuple_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="n">list_of_exprs</span> <span class="o">=</span> <span class="n">tuple_node</span><span class="o">.</span><span class="n">elts</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ExtSlice</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
            <span class="c1"># Python 3.8 returns an ExtSlice for region[0, :]</span>
            <span class="c1"># Python 3.9 directly returns a Tuple for region[0, 1]</span>
            <span class="n">node_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ExtSlice</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span>
            <span class="n">list_of_exprs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">axis_node</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="k">else</span> <span class="n">axis_node</span>
                <span class="k">for</span> <span class="n">axis_node</span> <span class="ow">in</span> <span class="n">node_list</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid &#39;region&#39; index at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span>
            <span class="p">)</span>
        <span class="n">axes_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">parallel_axes</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">AxisIntervalParser</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">axis_node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis_node</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list_of_exprs</span><span class="p">,</span> <span class="n">axes_names</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_visit_with_horizontal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">withitem</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AxisInterval</span><span class="p">]]:</span>
        <span class="n">syntax_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid &#39;with&#39; statement at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span>
        <span class="p">)</span>

        <span class="n">call_args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">call_args</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="s2">&quot;region&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">call_args</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">syntax_error</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_region_intervals</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">call_args</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_are_intervals_nonoverlapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compute_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compute_blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">compute_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">disjoint_from</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">interval</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_visit_iteration_order_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">withitem</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="p">):</span>
        <span class="n">syntax_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid &#39;computation&#39; specification at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span>
        <span class="p">)</span>
        <span class="n">comp_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">context_expr</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_node</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">.</span><span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">comp_node</span><span class="o">.</span><span class="n">keywords</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">syntax_error</span>

        <span class="k">if</span> <span class="n">comp_node</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">iteration_order_node</span> <span class="o">=</span> <span class="n">comp_node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iteration_order_node</span> <span class="o">=</span> <span class="n">comp_node</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iteration_order_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">iteration_order_node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">IterationOrder</span><span class="o">.</span><span class="n">__members__</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">syntax_error</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_order</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">IterationOrder</span><span class="p">[</span><span class="n">iteration_order_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_order</span>

    <span class="k">def</span> <span class="nf">_visit_interval_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">withitem</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="p">):</span>
        <span class="n">range_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid interval range specification at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">keywords</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">range_error</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;Two-argument syntax should not use AxisIndexs or AxisIntervals&quot;</span>
                <span class="p">)</span>
            <span class="n">interval_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">upper</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">interval_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interval_node</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">seq_name</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">sequential_axis</span><span class="o">.</span><span class="n">name</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">AxisIntervalParser</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">interval_node</span><span class="p">,</span> <span class="n">seq_name</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">interval</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">END</span>
            <span class="ow">and</span> <span class="n">interval</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">LevelMarker</span><span class="o">.</span><span class="n">START</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">interval</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">interval</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">level</span>
            <span class="ow">and</span> <span class="n">interval</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">interval</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">offset</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">range_error</span>

        <span class="k">return</span> <span class="n">interval</span>

    <span class="k">def</span> <span class="nf">_visit_computation_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">:</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">syntax_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid &#39;computation&#39; specification at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span>
        <span class="p">)</span>

        <span class="c1"># Parse computation specification, i.e. `withItems` nodes</span>
        <span class="n">iteration_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">intervals_dicts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;computation&quot;</span>
                <span class="p">):</span>
                    <span class="k">assert</span> <span class="n">iteration_order</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># only one spec allowed</span>
                    <span class="n">iteration_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_iteration_order_node</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;interval&quot;</span>
                <span class="p">):</span>
                    <span class="k">assert</span> <span class="n">interval</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># only one spec allowed</span>
                    <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_interval_node</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;horizontal&quot;</span>
                <span class="p">):</span>
                    <span class="n">intervals_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_with_horizontal</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">syntax_error</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">syntax_error</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">if</span> <span class="n">iteration_order</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">syntax_error</span>

        <span class="c1">#  Parse `With` body into computation blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">=</span> <span class="n">ParsingContext</span><span class="o">.</span><span class="n">COMPUTATION</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">stmts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">=</span> <span class="n">ParsingContext</span><span class="o">.</span><span class="n">CONTROL_FLOW</span>

        <span class="k">if</span> <span class="n">intervals_dicts</span><span class="p">:</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">HorizontalIf</span><span class="p">(</span>
                    <span class="n">intervals</span><span class="o">=</span><span class="n">intervals_dict</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">stmts</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">intervals_dict</span> <span class="ow">in</span> <span class="n">intervals_dicts</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">iteration_order</span><span class="o">=</span><span class="n">iteration_order</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="n">body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">stmts</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Visitor methods</span>
    <span class="c1"># -- Special nodes --</span>
<div class="viewcode-block" id="IRMaker.visit_Raise"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Raise">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">InvalidBranch</span><span class="p">()</span></div>

    <span class="c1"># -- Literal nodes --</span>
<div class="viewcode-block" id="IRMaker.visit_Constant"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Constant">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BuiltinLiteral</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Cast</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BuiltinLiteral</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Builtin</span><span class="o">.</span><span class="n">from_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Cast</span><span class="p">(</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span>
                <span class="n">expr</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BuiltinLiteral</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Builtin</span><span class="o">.</span><span class="n">from_value</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown constant value found: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">. Expected boolean or number.&quot;</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="IRMaker.visit_Tuple"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="c1"># -- Symbol nodes --</span>
<div class="viewcode-block" id="IRMaker.visit_Attribute"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Attribute">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
        <span class="c1"># Matrix Transposed</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOpExpr</span><span class="p">(</span>
                <span class="n">op</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="o">.</span><span class="n">TRANSPOSED</span><span class="p">,</span>
                <span class="n">arg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_qualified_name_from_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">))</span></div>

<div class="viewcode-block" id="IRMaker.visit_Name"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Ref</span><span class="p">:</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_field</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldRef</span><span class="o">.</span><span class="n">at_center</span><span class="p">(</span>
                <span class="n">symbol</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_parameter</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_local_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Logic error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39; symbol definition&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_Index"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Index">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span></div>

    <span class="k">def</span> <span class="nf">_eval_new_spatial_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">index_nodes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">field_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_spatial_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">)</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">axis_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">axis</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">ShiftedAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">field_axes</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">index_node</span> <span class="ow">in</span> <span class="n">index_nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">ast_eval</span><span class="p">(</span><span class="n">index_node</span><span class="p">,</span> <span class="n">axis_context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Could not evaluate axis shift expression.&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">index_node</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">gtscript</span><span class="o">.</span><span class="n">ShiftedAxis</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Axis</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Axis shift expression evaluated to unrecognized type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">index_node</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis_index</span> <span class="o">=</span> <span class="n">all_spatial_axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axis_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognized axis: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">index_node</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">axis_index</span> <span class="o">&lt;</span> <span class="n">last_index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Axis </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is specified out of order&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">index_node</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">axis_index</span> <span class="o">==</span> <span class="n">last_index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Duplicate axis found: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">index_node</span>
                    <span class="p">)</span>
                <span class="n">last_index</span> <span class="o">=</span> <span class="n">axis_index</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shift</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">index_dict</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">index_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">field_axes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_eval_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">,</span> <span class="n">field_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="n">tuple_or_expr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span>
        <span class="n">index_nodes</span> <span class="o">=</span> <span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span>
            <span class="n">tuple_or_expr</span><span class="o">.</span><span class="n">elts</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tuple_or_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">tuple_or_expr</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">)</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">index_nodes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid target in assignment.&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Ellipsis</span><span class="p">)</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">index_nodes</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Determine if we are using the new-style axis syntax, or the old style.</span>
        <span class="c1"># If this is parsing a data index, this should be fine and will return False.</span>
        <span class="n">new_style_spatial_syntax</span> <span class="o">=</span> <span class="n">field_axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_axes</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Axis</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">index_node</span> <span class="ow">in</span> <span class="n">index_nodes</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">index_node</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">new_style_spatial_syntax</span><span class="p">:</span>
            <span class="c1"># This is the new-style syntax for representing spatial axis offsets, e.g. [I+1]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_new_spatial_index</span><span class="p">(</span><span class="n">index_nodes</span><span class="p">,</span> <span class="n">field_axes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is either the old-style syntax using all spatial axes (e.g. [1, 0, 0]), or a data index.</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index_node</span> <span class="ow">in</span> <span class="n">index_nodes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">index_node</span><span class="p">)</span>
                    <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">index_node</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">index</span>

<div class="viewcode-block" id="IRMaker.visit_Subscript"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Subscript">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldRef</span><span class="p">):</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_index</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarRef</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">result</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="n">field_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Incorrect offset specification detected. Found </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but the field has dimensions (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_axes</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">{</span><span class="n">axis</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">field_axes</span><span class="p">,</span> <span class="n">index</span><span class="p">)}</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">data_index</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT32</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">value</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">index</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data_index</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dims</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Incorrect data index length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data_index</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid data dimension index. Field </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dims</span><span class="p">)</span><span class="si">}</span><span class="s2"> data dimensions.&quot;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ScalarLiteral</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">axis_length</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">data_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dims</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Data index out of bounds. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Found index </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">data_index</span><span class="si">}</span><span class="s2">, but field </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dims</span><span class="si">}</span><span class="s2"> data-dimensions&quot;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized subscript expression&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="c1"># -- Expressions nodes --</span>
<div class="viewcode-block" id="IRMaker.visit_UnaryOp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_UnaryOp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{op}{arg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">python_symbol</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOpExpr</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_UAdd"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_UAdd">[docs]</a>    <span class="k">def</span> <span class="nf">visit_UAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UAdd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="o">.</span><span class="n">POS</span></div>

<div class="viewcode-block" id="IRMaker.visit_USub"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_USub">[docs]</a>    <span class="k">def</span> <span class="nf">visit_USub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">USub</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="o">.</span><span class="n">NEG</span></div>

<div class="viewcode-block" id="IRMaker.visit_Not"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Not">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Not</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryOperator</span><span class="o">.</span><span class="n">NOT</span></div>

<div class="viewcode-block" id="IRMaker.visit_BinOp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_BinOp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">(</span>
            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">),</span>
            <span class="n">rhs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">),</span>
            <span class="n">lhs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="IRMaker.visit_Add"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Add">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">ADD</span></div>

<div class="viewcode-block" id="IRMaker.visit_Sub"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Sub">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Sub</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">SUB</span></div>

<div class="viewcode-block" id="IRMaker.visit_Mult"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Mult">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">MUL</span></div>

<div class="viewcode-block" id="IRMaker.visit_Div"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Div">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Div</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">DIV</span></div>

<div class="viewcode-block" id="IRMaker.visit_Mod"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Mod">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mod</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">MOD</span></div>

<div class="viewcode-block" id="IRMaker.visit_Pow"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Pow">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">POW</span></div>

<div class="viewcode-block" id="IRMaker.visit_MatMult"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_MatMult">[docs]</a>    <span class="k">def</span> <span class="nf">visit_MatMult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">MatMult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">MATMULT</span></div>

<div class="viewcode-block" id="IRMaker.visit_And"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_And">[docs]</a>    <span class="k">def</span> <span class="nf">visit_And</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">AND</span></div>

<div class="viewcode-block" id="IRMaker.visit_Or"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Or">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">OR</span></div>

<div class="viewcode-block" id="IRMaker.visit_Eq"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Eq">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">EQ</span></div>

<div class="viewcode-block" id="IRMaker.visit_NotEq"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_NotEq">[docs]</a>    <span class="k">def</span> <span class="nf">visit_NotEq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">NotEq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">NE</span></div>

<div class="viewcode-block" id="IRMaker.visit_Lt"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Lt">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">LT</span></div>

<div class="viewcode-block" id="IRMaker.visit_LtE"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_LtE">[docs]</a>    <span class="k">def</span> <span class="nf">visit_LtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">LtE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">LE</span></div>

<div class="viewcode-block" id="IRMaker.visit_Gt"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Gt">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Gt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Gt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">GT</span></div>

<div class="viewcode-block" id="IRMaker.visit_GtE"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_GtE">[docs]</a>    <span class="k">def</span> <span class="nf">visit_GtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">GtE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinaryOperator</span><span class="o">.</span><span class="n">GE</span></div>

<div class="viewcode-block" id="IRMaker.visit_BoolOp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_BoolOp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">rhs</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="IRMaker.visit_Compare"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Compare">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">:</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">lhs</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinOpExpr</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_IfExp"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_IfExp">[docs]</a>    <span class="k">def</span> <span class="nf">visit_IfExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">IfExp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TernaryOpExpr</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TernaryOpExpr</span><span class="p">(</span>
            <span class="n">condition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">),</span>
            <span class="n">then_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
            <span class="n">else_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_If"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="n">main_stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">main_stmts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Statement</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">main_stmts</span><span class="p">)</span>

        <span class="n">else_stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
                <span class="n">else_stmts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Statement</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">else_stmts</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
                <span class="n">condition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                <span class="n">main_body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">main_stmts</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)),</span>
                <span class="n">else_body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">else_stmts</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">else_stmts</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_While"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_While">[docs]</a>    <span class="k">def</span> <span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span> <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Statement</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">stmts</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">While</span><span class="p">(</span>
                <span class="n">condition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                <span class="n">body</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span><span class="n">stmts</span><span class="o">=</span><span class="n">stmts</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_Call"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="n">native_fcn</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFunction</span><span class="o">.</span><span class="n">PYTHON_SYMBOL_TO_IR_OP</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="n">native_fcn</span><span class="o">.</span><span class="n">arity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid native function call&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NativeFuncCall</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">native_fcn</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">AUTO</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
        <span class="p">)</span></div>

    <span class="c1"># -- Statement nodes --</span>
    <span class="k">def</span> <span class="nf">_parse_assign_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target_node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">invalid_target</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid target in assignment.&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">target_node</span>
        <span class="p">)</span>
        <span class="n">spatial_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">.</span><span class="n">id</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span>
                <span class="n">spatial_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_index</span><span class="p">(</span><span class="n">target_node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span>
            <span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span>
                <span class="n">spatial_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_index</span><span class="p">(</span><span class="n">target_node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">data_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_index</span><span class="p">(</span><span class="n">target_node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">invalid_target</span>
            <span class="k">if</span> <span class="n">spatial_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_axes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">else</span> <span class="mi">3</span>
                <span class="n">spatial_offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">invalid_target</span>

        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">spatial_offset</span><span class="p">,</span> <span class="n">data_index</span>

<div class="viewcode-block" id="IRMaker.visit_Assign"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create decls for temporary fields</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Assignment to multiple variables (e.g. var1 = var2 = value) not supported.&quot;</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">elts</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">spatial_offset</span><span class="p">,</span> <span class="n">data_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_assign_target</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spatial_offset</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">spatial_offset</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Assignment to non-zero offsets is not supported.&quot;</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_known</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_decls</span><span class="p">:</span>
                    <span class="n">field_decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_decls</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data_index</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Temporaries with data dimensions need to be declared explicitly.&quot;</span><span class="p">,</span>
                            <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="n">field_decl</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">AUTO</span><span class="p">,</span>
                        <span class="n">axes</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">axes_names</span><span class="p">,</span>
                        <span class="n">is_api</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">decls_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_decl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_decl</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_decl</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_decl</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsing_horizontal_region</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">written_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
            <span class="n">par_axes_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">parallel_axes</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_order</span> <span class="o">==</span> <span class="n">nodes</span><span class="o">.</span><span class="n">IterationOrder</span><span class="o">.</span><span class="n">PARALLEL</span><span class="p">:</span>
                <span class="n">par_axes_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span><span class="o">.</span><span class="n">sequential_axis</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">par_axes_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cannot assign to field &#39;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; as all parallel axes &#39;</span><span class="si">{</span><span class="n">par_axes_names</span><span class="si">}</span><span class="s2">&#39; are not present.&quot;</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="IRMaker.visit_AugAssign"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_AugAssign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement left &lt;op&gt;= right in terms of left = left &lt;op&gt; right.&quot;&quot;&quot;</span>
        <span class="n">binary_operation</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">binary_operation</span><span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">binary_operation</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_Assign</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span></div>

<div class="viewcode-block" id="IRMaker.visit_With"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_With">[docs]</a>    <span class="k">def</span> <span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">syntax_error</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid &#39;with&#39; statement at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;horizontal&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">child_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span> <span class="k">for</span> <span class="n">child_node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="s2">&quot;Cannot nest `with` node inside horizontal region&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parsing_horizontal_region</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">intervals_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_with_horizontal</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loc</span><span class="p">)</span>
            <span class="n">all_stmts</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span><span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">))</span> <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parsing_horizontal_region</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">stmts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stmt</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Decl</span><span class="p">),</span> <span class="n">all_stmts</span><span class="p">))</span>
            <span class="n">body_block</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BlockStmt</span><span class="p">(</span>
                <span class="n">stmts</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stmt</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Decl</span><span class="p">),</span> <span class="n">all_stmts</span><span class="p">)),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">_find_accesses_with_offsets</span><span class="p">(</span><span class="n">body_block</span><span class="p">)</span>
            <span class="n">written_then_offset</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">written_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">written_then_offset</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="s2">&quot;The following variables are&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;written before being referenced with an offset in a horizontal region: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">written_then_offset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">stmts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">HorizontalIf</span><span class="p">(</span><span class="n">intervals</span><span class="o">=</span><span class="n">intervals_dict</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body_block</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">intervals_dict</span> <span class="ow">in</span> <span class="n">intervals_dicts</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">stmts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we find nested `with` blocks flatten them, i.e. transform</span>
            <span class="c1">#  with computation(PARALLEL):</span>
            <span class="c1">#   with interval(...):</span>
            <span class="c1">#     ...</span>
            <span class="c1"># into</span>
            <span class="c1">#  with computation(PARALLEL), interval(...):</span>
            <span class="c1">#    ...</span>
            <span class="c1"># otherwise just parse the node</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">==</span> <span class="n">ParsingContext</span><span class="o">.</span><span class="n">CONTROL_FLOW</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">child_node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;interval&quot;</span>
                <span class="k">for</span> <span class="n">child_node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>
            <span class="p">):</span>
                <span class="c1"># Ensure top level `with` specifies the iteration order</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">with_item</span><span class="o">.</span><span class="n">context_expr</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;computation&quot;</span>
                    <span class="k">for</span> <span class="n">with_item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">with_item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">syntax_error</span>

                <span class="c1"># Parse nested `with` blocks</span>
                <span class="n">compute_blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">with_node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                    <span class="n">with_node</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">with_node</span><span class="p">)</span>  <span class="c1"># Copy to avoid altering original ast</span>
                    <span class="c1"># Splice `withItems` of current/primary with statement into nested with</span>
                    <span class="n">with_node</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

                    <span class="n">compute_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit_computation_node</span><span class="p">(</span><span class="n">with_node</span><span class="p">))</span>

                <span class="c1"># Validate block specification order</span>
                <span class="c1">#  the nested computation blocks must be specified in their order of execution. The order of execution is</span>
                <span class="c1">#  such that the lowest (highest) interval is processed first if the iteration order is forward (backward).</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_blocks_sorted</span><span class="p">(</span><span class="n">compute_blocks</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid &#39;with&#39; statement at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">). Intervals must be specified in order of execution.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_intervals_nonoverlapping</span><span class="p">(</span><span class="n">compute_blocks</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Overlapping intervals detected at line </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">line</span><span class="si">}</span><span class="s2"> (column </span><span class="si">{</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="n">compute_blocks</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsing_context</span> <span class="o">==</span> <span class="n">ParsingContext</span><span class="o">.</span><span class="n">CONTROL_FLOW</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gtc_utils</span><span class="o">.</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit_computation_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Mixing nested `with` blocks with stmts not allowed</span>
                <span class="k">raise</span> <span class="n">syntax_error</span></div>

<div class="viewcode-block" id="IRMaker.visit_FunctionDef"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.IRMaker.visit_FunctionDef">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">]:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ComputationBlock</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid stencil definition&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">blocks</span></div></div>


<div class="viewcode-block" id="CollectLocalSymbolsAstVisitor"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CollectLocalSymbolsAstVisitor">[docs]</a><span class="k">class</span> <span class="nc">CollectLocalSymbolsAstVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
<div class="viewcode-block" id="CollectLocalSymbolsAstVisitor.apply"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CollectLocalSymbolsAstVisitor.apply">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="CollectLocalSymbolsAstVisitor.__call__"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CollectLocalSymbolsAstVisitor.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CollectLocalSymbolsAstVisitor.visit_Assign"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.CollectLocalSymbolsAstVisitor.visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
        <span class="n">invalid_target</span> <span class="o">=</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;invalid target in assign&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                        <span class="n">name_node</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                        <span class="n">name_node</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">invalid_target</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">local_symbols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name_node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">invalid_target</span></div></div>


<div class="viewcode-block" id="GTScriptParser"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser">[docs]</a><span class="k">class</span> <span class="nc">GTScriptParser</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="n">CONST_VALUE_TYPES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">*</span><span class="n">gtscript</span><span class="o">.</span><span class="n">_VALID_DATA_TYPES</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">gtscript</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span>
        <span class="n">gtscript</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">externals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">decorators_source</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">split_def_decorators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">feature_version</span><span class="o">=</span><span class="n">PYTHON_AST_VERSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_info</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">build_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition_ir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_context</span> <span class="o">=</span> <span class="n">externals</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_externals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&lt;GT4Py.GTScriptParser&gt; {</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="GTScriptParser.annotate_definition"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.annotate_definition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">annotate_definition</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">api_signature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">api_annotations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">qualified_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">definition</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptDefinitionError</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">qualified_name</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;*args&#39; tuple parameter is not supported in GTScript definitions&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptDefinitionError</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">qualified_name</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;**kwargs&#39; dict parameter is not supported in GTScript definitions&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_keyword</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span>

                <span class="n">default</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Empty</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">CONST_VALUE_TYPES</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">GTScriptValueError</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid default value for argument &#39;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_FieldDescriptor</span><span class="p">)):</span>
                    <span class="n">dtype_annotation</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_VALID_DATA_TYPES</span>
                <span class="p">):</span>
                    <span class="n">dtype_annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">dtype_annotation</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptValueError</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid annotated dtype value for argument &#39;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">api_signature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">ArgumentInfo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">is_keyword</span><span class="o">=</span><span class="n">is_keyword</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">api_annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtype_annotation</span><span class="p">)</span>

        <span class="n">nonlocal_symbols</span><span class="p">,</span> <span class="n">imported_symbols</span> <span class="o">=</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">collect_external_symbols</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
        <span class="n">ast_func_def</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_ast</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">feature_version</span><span class="o">=</span><span class="n">PYTHON_AST_VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">canonical_ast</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">ast_dump</span><span class="p">(</span><span class="n">ast_func_def</span><span class="p">,</span> <span class="n">feature_version</span><span class="o">=</span><span class="n">PYTHON_AST_VERSION</span><span class="p">)</span>

        <span class="c1"># resolve externals</span>
        <span class="k">if</span> <span class="n">externals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resolved_externals</span> <span class="o">=</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">resolve_external_symbols</span><span class="p">(</span>
                <span class="n">nonlocal_symbols</span><span class="p">,</span> <span class="n">imported_symbols</span><span class="p">,</span> <span class="n">externals</span>
            <span class="p">)</span>

        <span class="c1"># Gather temporary</span>
        <span class="n">temp_annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_FieldDescriptor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp_init_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">ann_assign_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Field&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span>
            <span class="s2">&quot;IJK&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">IJK</span><span class="p">,</span>
            <span class="s2">&quot;IJ&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">IJ</span><span class="p">,</span>
            <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">I</span><span class="p">,</span>
            <span class="s2">&quot;J&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">J</span><span class="p">,</span>
            <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
            <span class="s2">&quot;IK&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">IK</span><span class="p">,</span>
            <span class="s2">&quot;JK&quot;</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">JK</span><span class="p">,</span>
            <span class="s2">&quot;np&quot;</span><span class="p">:</span> <span class="n">np</span><span class="p">,</span>
            <span class="o">**</span><span class="p">(</span><span class="n">resolved_externals</span> <span class="k">if</span> <span class="n">externals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nonlocal_symbols</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">ann_assigns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stmt</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">),</span> <span class="n">ast_func_def</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ann_assign</span> <span class="ow">in</span> <span class="n">ann_assigns</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ann_assign</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ann_assign</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">ast_unparse</span><span class="p">(</span><span class="n">ann_assign</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ann_assign_context</span><span class="p">)</span>
            <span class="n">temp_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">descriptor</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">axes</span> <span class="o">!=</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">IJK</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">axes</span><span class="si">}</span><span class="s2">, but only IJK is currently supported for temporaries&quot;</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">ast_func_def</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ann_assign</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ann_assign</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ann_assign</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">temp_init_values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ann_assign</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span>

        <span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">qualified_name</span><span class="o">=</span><span class="n">qualified_name</span><span class="p">,</span>
            <span class="n">api_signature</span><span class="o">=</span><span class="n">api_signature</span><span class="p">,</span>
            <span class="n">api_annotations</span><span class="o">=</span><span class="n">api_annotations</span><span class="p">,</span>
            <span class="n">temp_annotations</span><span class="o">=</span><span class="n">temp_annotations</span><span class="p">,</span>
            <span class="n">temp_init_values</span><span class="o">=</span><span class="n">temp_init_values</span><span class="p">,</span>
            <span class="n">canonical_ast</span><span class="o">=</span><span class="n">canonical_ast</span><span class="p">,</span>
            <span class="n">nonlocals</span><span class="o">=</span><span class="n">nonlocal_symbols</span><span class="p">,</span>
            <span class="n">imported</span><span class="o">=</span><span class="n">imported_symbols</span><span class="p">,</span>
            <span class="n">externals</span><span class="o">=</span><span class="n">resolved_externals</span> <span class="k">if</span> <span class="n">externals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{},</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">definition</span></div>

<div class="viewcode-block" id="GTScriptParser.collect_external_symbols"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.collect_external_symbols">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_external_symbols</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>
        <span class="n">gtscript_ast</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_ast</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">feature_version</span><span class="o">=</span><span class="n">PYTHON_AST_VERSION</span><span class="p">)</span>

        <span class="n">bare_imports</span><span class="p">,</span> <span class="n">from_imports</span><span class="p">,</span> <span class="n">relative_imports</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">collect_imported_symbols</span><span class="p">(</span>
            <span class="n">gtscript_ast</span>
        <span class="p">)</span>
        <span class="n">wrong_imports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bare_imports</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">relative_imports</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">imported_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">from_imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># Aliasing imported names is not allowed</span>
                <span class="n">wrong_imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;__externals__.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gt4py.cartesian.__externals__.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__gtscript__.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gt4py.cartesian.__gtscript__.&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s2">&quot;__externals__&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">imported_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wrong_imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wrong_imports</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;import&#39; statements (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wrong_imports</span><span class="p">))</span>

        <span class="n">context</span><span class="p">,</span> <span class="n">unbound</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_closure</span><span class="p">(</span>
            <span class="n">definition</span><span class="p">,</span> <span class="n">included_nonlocals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_builtins</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">imported_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">imported_names</span><span class="p">}</span>
        <span class="n">local_symbols</span> <span class="o">=</span> <span class="n">CollectLocalSymbolsAstVisitor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gtscript_ast</span><span class="p">)</span>
        <span class="n">nonlocal_symbols</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">name_nodes</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">collect_names</span><span class="p">(</span><span class="n">gtscript_ast</span><span class="p">,</span> <span class="n">skip_annotations</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">collected_name</span> <span class="ow">in</span> <span class="n">name_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">collected_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">builtins</span><span class="p">:</span>
                <span class="n">root_name</span> <span class="o">=</span> <span class="n">collected_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">root_name</span> <span class="ow">in</span> <span class="n">imported_symbols</span><span class="p">:</span>
                    <span class="n">imported_symbols</span><span class="p">[</span><span class="n">root_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="n">collected_name</span><span class="p">,</span> <span class="n">name_nodes</span><span class="p">[</span><span class="n">collected_name</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">root_name</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                    <span class="n">nonlocal_symbols</span><span class="p">[</span><span class="n">collected_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">eval_external</span><span class="p">(</span>
                        <span class="n">collected_name</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                        <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">name_nodes</span><span class="p">[</span><span class="n">collected_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nonlocal_symbols</span><span class="p">[</span><span class="n">collected_name</span><span class="p">],</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
                        <span class="c1"># Recursively add nonlocals and imported symbols</span>
                        <span class="n">nonlocal_symbols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">nonlocal_symbols</span><span class="p">[</span><span class="n">collected_name</span><span class="p">]</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;nonlocals&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">imported_symbols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">nonlocal_symbols</span><span class="p">[</span><span class="n">collected_name</span><span class="p">]</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;imported&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">root_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_symbols</span> <span class="ow">and</span> <span class="n">root_name</span> <span class="ow">in</span> <span class="n">unbound</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptSymbolError</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">collected_name</span><span class="p">,</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">name_nodes</span><span class="p">[</span><span class="n">collected_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">nonlocal_symbols</span><span class="p">,</span> <span class="n">imported_symbols</span></div>

<div class="viewcode-block" id="GTScriptParser.eval_external"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.eval_external">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_external</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">CONST_VALUE_TYPES</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GTScriptDefinitionError</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Missing or invalid value for external symbol </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="GTScriptParser.resolve_external_symbols"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.resolve_external_symbols">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resolve_external_symbols</span><span class="p">(</span>
        <span class="n">nonlocals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">imported</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exhaustive</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">accepted_imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">imported</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">resolved_imports</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">imported</span><span class="p">}</span>
        <span class="n">resolved_values_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nonlocals</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="c1"># Resolve function-like imports</span>
        <span class="n">func_externals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">resolved_values_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">func_externals</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a gtscript function&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">imported_name</span><span class="p">,</span> <span class="n">imported_value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;imported&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">resolved_imports</span><span class="p">[</span><span class="n">imported_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">imported_value</span>

        <span class="c1"># Collect all imported and inlined values recursively through all the external symbols</span>
        <span class="n">last_resolved_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">resolved_imports</span> <span class="ow">or</span> <span class="n">resolved_values_list</span><span class="p">:</span>
            <span class="n">new_imports</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">accesses</span> <span class="ow">in</span> <span class="n">resolved_imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">accesses</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_nodes</span> <span class="ow">in</span> <span class="n">accesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">resolved_values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">attr_name</span><span class="p">,</span>
                                <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">eval_external</span><span class="p">(</span>
                                    <span class="n">attr_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="n">attr_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                <span class="k">elif</span> <span class="ow">not</span> <span class="n">exhaustive</span><span class="p">:</span>
                    <span class="n">resolved_values_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">eval_external</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resolved_values_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exhaustive</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">nested_inlined_values</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;qualified_name&quot;</span><span class="p">],</span> <span class="n">item_name</span><span class="p">):</span> <span class="n">item_value</span>
                        <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">item_value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;nonlocals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                    <span class="n">resolved_values_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nested_inlined_values</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                    <span class="k">for</span> <span class="n">imported_name</span><span class="p">,</span> <span class="n">imported_name_accesses</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span>
                        <span class="s2">&quot;imported&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">imported_name</span> <span class="ow">in</span> <span class="n">accepted_imports</span><span class="p">:</span>
                            <span class="c1"># Only check names explicitly imported in the main caller context</span>
                            <span class="n">new_imports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">imported_name</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_nodes</span> <span class="ow">in</span> <span class="n">imported_name_accesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">new_imports</span><span class="p">[</span><span class="n">imported_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="p">[])</span>
                                <span class="n">new_imports</span><span class="p">[</span><span class="n">imported_name</span><span class="p">][</span><span class="n">attr_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr_nodes</span><span class="p">)</span>

            <span class="c1"># Check that we aren&#39;t recursively importing the same function</span>
            <span class="n">current_resolved_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resolved_values_list</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">last_resolved_values</span> <span class="o">==</span> <span class="n">current_resolved_values</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptSyntaxError</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found recursive imports </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_resolved_values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">last_resolved_values</span> <span class="o">=</span> <span class="n">current_resolved_values</span>

            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">resolved_values_list</span><span class="p">))</span>
            <span class="n">resolved_imports</span> <span class="o">=</span> <span class="n">new_imports</span>
            <span class="n">resolved_values_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GTScriptParser.extract_arg_descriptors"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.extract_arg_descriptors">[docs]</a>    <span class="k">def</span> <span class="nf">extract_arg_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">api_signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;api_signature&quot;</span><span class="p">]</span>
        <span class="n">api_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;api_annotations&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_signature</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_annotations</span><span class="p">)</span>
        <span class="n">fields_decls</span><span class="p">,</span> <span class="n">parameter_decls</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">arg_info</span><span class="p">,</span> <span class="n">arg_annotation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">api_signature</span><span class="p">,</span> <span class="n">api_annotations</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">arg_annotation</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_VALID_DATA_TYPES</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">arg_annotation</span><span class="p">,</span> <span class="p">(</span><span class="n">gtscript</span><span class="o">.</span><span class="n">_SequenceDescriptor</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_FieldDescriptor</span><span class="p">)</span>
                <span class="p">),</span> <span class="s2">&quot;Invalid parameter annotation&quot;</span>

                <span class="k">if</span> <span class="n">arg_annotation</span> <span class="ow">in</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_VALID_DATA_TYPES</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">arg_annotation</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">arg_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Empty</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg_info</span><span class="o">.</span><span class="n">default</span><span class="p">))</span> <span class="o">==</span> <span class="n">dtype</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">parameter_decls</span><span class="p">[</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarDecl</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_api</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_annotation</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_SequenceDescriptor</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">arg_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Empty</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">arg_annotation</span><span class="p">))</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">arg_annotation</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">parameter_decls</span><span class="p">[</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">VarDecl</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">is_api</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_annotation</span><span class="p">,</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">_FieldDescriptor</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">arg_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Empty</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">arg_annotation</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">arg_annotation</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
                    <span class="n">data_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg_annotation</span><span class="o">.</span><span class="n">data_dims</span><span class="p">)</span>
                    <span class="n">fields_decls</span><span class="p">[</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FieldDecl</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">data_dims</span><span class="o">=</span><span class="n">data_dims</span><span class="p">,</span>
                        <span class="n">is_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">layout_id</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GTScriptDataTypeError</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptDefinitionError</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">arg_annotation</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid definition of argument &#39;</span><span class="si">{</span><span class="n">arg_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">arg_annotation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">fields_decls</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">parameter_decls</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">data_type</span> <span class="ow">is</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GTScriptDataTypeError</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api_signature</span><span class="p">,</span> <span class="n">fields_decls</span><span class="p">,</span> <span class="n">parameter_decls</span></div>

<div class="viewcode-block" id="GTScriptParser.run"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptParser.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;body&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="o">.</span><span class="n">_fields</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">main_func_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_externals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;externals&quot;</span><span class="p">]</span>
        <span class="n">api_signature</span><span class="p">,</span> <span class="n">fields_decls</span><span class="p">,</span> <span class="n">parameter_decls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_arg_descriptors</span><span class="p">()</span>

        <span class="c1"># Inline constant values</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_externals</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">func_node</span> <span class="o">=</span> <span class="n">gt_meta</span><span class="o">.</span><span class="n">get_ast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">feature_version</span><span class="o">=</span><span class="n">PYTHON_AST_VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">local_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_external_symbols</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;nonlocals&quot;</span><span class="p">],</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;imported&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">external_context</span><span class="p">,</span>
                    <span class="n">exhaustive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ValueInliner</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func_node</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">local_context</span><span class="p">)</span>
                <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;ast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_node</span>
                <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;local_context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_context</span>

        <span class="n">local_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_external_symbols</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;nonlocals&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;imported&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_context</span><span class="p">,</span>
            <span class="n">exhaustive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ValueInliner</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">main_func_node</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">local_context</span><span class="p">)</span>

        <span class="c1"># Inline function calls</span>
        <span class="n">CallInliner</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">main_func_node</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">local_context</span><span class="p">)</span>

        <span class="c1"># Evaluate and inline compile-time conditionals</span>
        <span class="n">CompiledIfInliner</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">main_func_node</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">local_context</span><span class="p">,</span> <span class="n">stencil_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_name</span><span class="p">)</span>

        <span class="n">AssertionChecker</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">main_func_node</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">local_context</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="n">temp_decls</span> <span class="o">=</span> <span class="n">_make_temp_decls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;temp_annotations&quot;</span><span class="p">])</span>
        <span class="n">fields_decls</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp_decls</span><span class="p">)</span>

        <span class="n">init_computations</span> <span class="o">=</span> <span class="n">_make_init_computations</span><span class="p">(</span>
            <span class="n">temp_decls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;temp_init_values&quot;</span><span class="p">],</span> <span class="n">func_node</span><span class="o">=</span><span class="n">main_func_node</span>
        <span class="p">)</span>

        <span class="c1"># Generate definition IR</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">()</span>
        <span class="n">computations</span> <span class="o">=</span> <span class="n">IRMaker</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="n">fields_decls</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameter_decls</span><span class="p">,</span>
            <span class="n">local_symbols</span><span class="o">=</span><span class="p">{},</span>  <span class="c1"># Not used</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">temp_decls</span><span class="o">=</span><span class="n">temp_decls</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">definition_ir</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">StencilDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_name</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">api_signature</span><span class="o">=</span><span class="n">api_signature</span><span class="p">,</span>
            <span class="n">api_fields</span><span class="o">=</span><span class="p">[</span>
                <span class="n">fields_decls</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">api_signature</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">fields_decls</span>
            <span class="p">],</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                <span class="n">parameter_decls</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">api_signature</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_decls</span>
            <span class="p">],</span>
            <span class="n">computations</span><span class="o">=</span><span class="n">init_computations</span> <span class="o">+</span> <span class="n">computations</span> <span class="k">if</span> <span class="n">init_computations</span> <span class="k">else</span> <span class="n">computations</span><span class="p">,</span>
            <span class="n">externals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_externals</span><span class="p">,</span>
            <span class="n">docstring</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">nodes</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">from_ast_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_root</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">definition_ir</span> <span class="o">=</span> <span class="n">UnrollVectorAssignments</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">definition_ir</span><span class="p">,</span> <span class="n">fields_decls</span><span class="o">=</span><span class="n">fields_decls</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition_ir</span></div></div>


<div class="viewcode-block" id="GTScriptFrontend"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptFrontend">[docs]</a><span class="nd">@register</span>
<span class="k">class</span> <span class="nc">GTScriptFrontend</span><span class="p">(</span><span class="n">Frontend</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;gtscript&quot;</span>

<div class="viewcode-block" id="GTScriptFrontend.get_stencil_id"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptFrontend.get_stencil_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_stencil_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="p">,</span> <span class="n">options_id</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_stencil_definition</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">externals</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;__main__&quot;</span><span class="p">:</span> <span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;canonical_ast&quot;</span><span class="p">],</span>
            <span class="s2">&quot;docstring&quot;</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">definition</span><span class="p">),</span>
            <span class="s2">&quot;api_annotations&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s1">&#39;api_annotations&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;externals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fingerprint</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">value</span><span class="o">.</span><span class="n">_gtscript_</span><span class="p">[</span><span class="s2">&quot;canonical_ast&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
            <span class="p">)</span>

        <span class="n">definition_id</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">shashed_id</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">gt_utils</span><span class="o">.</span><span class="n">shashed_id</span><span class="p">(</span><span class="n">definition_id</span><span class="p">,</span> <span class="n">options_id</span><span class="p">)</span>
        <span class="n">stencil_id</span> <span class="o">=</span> <span class="n">gt_definitions</span><span class="o">.</span><span class="n">StencilID</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stencil_id</span></div>

<div class="viewcode-block" id="GTScriptFrontend.prepare_stencil_definition"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptFrontend.prepare_stencil_definition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prepare_stencil_definition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GTScriptParser</span><span class="o">.</span><span class="n">annotate_definition</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="p">)</span></div>

<div class="viewcode-block" id="GTScriptFrontend.generate"><a class="viewcode-back" href="../../../../_source/gt4py.cartesian.frontend.html#gt4py.cartesian.frontend.gtscript_frontend.GTScriptFrontend.generate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">build_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="s2">&quot;_gtscript_&quot;</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_stencil_definition</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="p">)</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">GTScriptParser</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">externals</span><span class="o">=</span><span class="n">externals</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="n">definition_ir</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="c1"># GTIR only supports LatLonGrids</span>
        <span class="k">if</span> <span class="n">definition_ir</span><span class="o">.</span><span class="n">domain</span> <span class="o">!=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">LatLonGrid</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;GTIR does not support grids other than LatLong.&quot;</span><span class="p">)</span>
        <span class="n">gtir_stencil</span> <span class="o">=</span> <span class="n">DefIRToGTIR</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">definition_ir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">build_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">build_info</span><span class="p">[</span><span class="s2">&quot;parse_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">return</span> <span class="n">gtir_stencil</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014-2022, ETH Zurich.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>